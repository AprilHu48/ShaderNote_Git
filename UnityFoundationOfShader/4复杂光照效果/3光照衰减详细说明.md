上节我们提到, Unity 使用一张纹理作为查找表来在片元着色器中计算逐像素光照的 衰减。这样的好处在于,计算衰减不依赖于数学公式的复杂性,我们只要使用一个参数值去纹理 中采样即可。但使用纹理查找来计算衰减也有一些弊端。

* 需要预处理得到采样纹理,而且纹理的大小也会影响衰减的精度。
* 不直观,同时也不方便,因此一旦把数据存储到查找表中,我们就无法使用其他数学公式 来计算衰减。

但由于这种方法可以在一定程度上提升性能,而且得到的效果在大部分情况下都是良好的, 因此 Unity 默认就是使用这种纹理查找的方式来计算逐像素的点光源和聚光灯的衰减的。

###  用于光照衰减的纹理

Unity 在内部使用一张名为_LightTexture0 的纹理来计算光源衰减。需要注意的是,如果我们 对该光源使用了 cookie,那么衰减查找纹理是_LightTextureB0,但这里不讨论这种情况。我们通常只关心 LightTexture0 对角线上的纹理颜色值,这些值表明了在光源空间中不同位置的点的衰减 值。例如,(0,0)点表明了与光源位置重合的点的衰减值,而(1,1)点表明了在光源空间中所关心的距离最远的点的衰减。

为了对Light Texture0 纹理采样得到给定点到该光源的衰减值,我们首先需要得到该点在光源 空间中的位置,这是通过unity_WorldToLight (替代了LightMatrix0) 变换矩阵得到的。在上节中,我们已经知道unity_WorldToLight 可以把顶点从世界空间变换到光源空间。因此,我们只需要把unity_WorldToLight和世界空间中的顶点 坐标相乘即可得到光源空间中的相应位置:

```
float3 lightCoord = mul(unity_WorldToLight, float4(i.worldPosition, 1)).xyz;
```

然后,我们可以使用这个坐标的模的平方对衰减纹理进行采样,得到衰减值:

```
fixed atten = tex2D(_LightTexture0, dot (lightCoord, lightCoord).rr).UNITY_ATTEN_CHANNEL;
```

上面的代码中,我们使用了光源空间中顶点距离的平方(通过 dot 函数来得到) 来对纹理采样,之所以没有使用距离值来采样是因为这种方法可以避免开方操作。rr表示uv坐标均取的r通道值.然后,我们使用宏 UNITY ATTEN CHANNEL 来得到衰减纹理中衰减值所在的分量,以得到最终的衰减值。

### 使用数学公式计算衰减

尽管纹理采样的方法可以减少计算衰减时的复杂度,但有时我们希望可以在代码中利用公式来计算光源的衰减。例如,下面的代码可以计算光源的线性衰减:

```
float distance = length(_WorldSpaceLightPos0.xyz - i.worldPosition.xyz);
atten = 1.0 / distance; // linear attenuation
```

unity 没有在文档中给出内置衰减计算的相关说明。尽管我们仍然可以在片元着色器中利用一些数学公式来计算衰减,但由于我们无法在 Shader 中通过内置变量得到光源的范 围、聚光灯的朝向、张开角度等信息,因此得到的效果往往在有些时候不尽如人意,尤其在物体离开光源的照明范围时会发生突变(这是因为,如果物体不在该光源的照明范围内,Unity 就不会为物体执行一个 Additional Pass).